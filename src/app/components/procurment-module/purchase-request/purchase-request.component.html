<div class="main-container">
  <mat-toolbar style="height: 100px;background-color: #fff;">
    <div style="margin-top: 40px;margin-left: 20px;">
      <img src="./assets/images/preq.svg">
    </div>
    <span
      style="font-family: 'Poppins';margin-top: 40px;font-style: normal;font-weight:600;font-size: 30px;color:#1E293B;margin-left: 10px;">Purchase
      Request </span>
    <span class="example-spacer"></span>


  </mat-toolbar>
  <div>
    <hr style="width: 1130px;border: 2px solid #C5C5C5;margin-left: 30px;">
  </div>
  <div style="display: flex;flex-direction: row;font-family: 'Poppins';font-weight: 600;">

    <div style="margin-top: 20px;margin-left: 30px;display: flex;cursor: pointer;" [routerLink]="['/procurement']" routerLinkActive="active-link">

      <div><img src="./assets/images/prl.svg"></div>
      <span style="color: #233A61;margin-left: 5px;font-size: 14px;">Purchase&nbsp;request</span>
      <div><mat-divider style="width: 90px;margin-left: 10px;margin-top: 10px;border:1px dashed"></mat-divider></div>
    </div>
    <div style="margin-top: 20px;margin-left: 10px;display: flex;cursor: pointer;" [routerLink]="['/procurement/prlist']" routerLinkActive="active-link">

      <div> <img src="./assets/images/approval.svg"></div>
      <span style="color: #97989D;margin-left: 5px;font-size: 14px;">Approvals</span>
      <div><mat-divider style="width: 90px;margin-left: 10px;margin-top: 10px;border:1px dashed"></mat-divider></div>
    </div>
    <div style="margin-top: 20px;margin-left: 10px;display: flex;cursor: pointer;" [routerLink]="['/rate-comparative']" routerLinkActive="active-link">
      <div> <img src="./assets/images/rc.svg"></div>
      <span style="color: #97989D;margin-left: 5px;font-size: 14px;">Rate&nbsp;Comparative</span>
      <div><mat-divider style="width: 90px;margin-left: 10px;margin-top: 10px;border:1px dashed"></mat-divider></div>
    </div>
    <div style="margin-top: 20px;margin-left: 10px;display: flex; cursor: pointer;" [routerLink]="['/rate-approval']" routerLinkActive="active-link">
      <div> <img src="./assets/images/approval.svg"></div>
      <span style="color: #97989D;margin-left: 5px;font-size: 14px;">Rate&nbsp;Approvals</span>
      <div><mat-divider style="width: 100px;margin-left: 10px;margin-top: 10px;border:1px dashed"></mat-divider></div>
    </div>
    <div style="margin-top: 20px;margin-left: 10px;display: flex;cursor: pointer;" [routerLink]="['/purchase-order']" routerLinkActive="active-link">
      <div><img src="./assets/images/po.svg"></div>
      <span style="color: #97989D;margin-left: 5px;font-size: 14px;">Purchase&nbsp;orders</span>
    </div>
  </div>
<ng-container *ngIf="viewPermission; else noView">
  <div class="requests">
    <div [ngClass]="{'active':option==1}" (click)="option=1">Create request</div>
    <div [ngClass]="{'active':option==2}"
      (click)="option=2;getPurchaseList({ filter_by: filter_by, filter_value: statusOption.value })"> Request list
    </div>
  </div>

  <ng-container *ngIf="option==1">
    <form (ngSubmit)="onSubmit()" [formGroup]="purchaseRequestForm">


      <mat-card class="topcard">
        <div style="display: flex;flex-wrap: wrap;gap:10px; max-width: 100%;">
          <div class="flex-div" style="display: flex;flex-direction: column">
            <label style="color: #4272BF;font-size: 14px;">Request title <span class="star">*</span></label>
              <mat-select id="title" placeholder="Select title" formControlName="title" (selectionChange)="selectedTitle($event)"
              style="padding: 10px;width: 75%;border:1px solid #ccc;border-radius: 6px;cursor: pointer;font-family: 'Poppins';">
              <mat-option [value]="item._id" *ngFor="let item of categoryList">
                {{item.name}}
              </mat-option>
            </mat-select>
            </div>
          <div class="flex-div custom-form-group">
            <label style="color: #4272BF;font-size: 14px;">Request date</label>
            <div class="custom-form-control">
              <mat-form-field appearance="outline">
                <input matInput formControlName="date" [readonly]="true" placeholder="Enter Required by date" />
                <mat-datepicker-toggle matSuffix></mat-datepicker-toggle>
                <mat-datepicker></mat-datepicker>

              </mat-form-field>
            </div>
          </div>

          <div class="flex-div custom-form-group" style="margin-right: 45px;">
            <label class="custom-label" for="" style="color: #4272BF;font-size: 14px;"> Required By <span
                class="star">*</span>
            </label>
            <div class="custom-form-control">
              <mat-form-field appearance="outline">
                <input matInput [matDatepicker]="requiredByStartDate" formControlName="expected_delivery_date"
                  placeholder="Enter Required by date" style="width: 100%;" [min]="requredByMinDate"
                  (click)="requiredByStartDate.open()" />
                <mat-datepicker-toggle matSuffix [for]="requiredByStartDate"></mat-datepicker-toggle>
                <mat-datepicker #requiredByStartDate></mat-datepicker>

              </mat-form-field>
            </div>
          </div>
          <div class="flex-div" style="display: flex;flex-direction: column;">
            <label style="color: #4272BF;font-size: 14px;">Site name <span class="star">*</span></label>
              <mat-select id="site" placeholder="Select site" formControlName="site" (selectionChange)="selectedSite($event)"
              style="padding: 10px;width: 75%;border:1px solid #ccc;border-radius: 6px;cursor: pointer;font-family: 'Poppins';">
              <mat-option [value]="item._id" *ngFor="let item of siteList">
                {{item.site_name}}
              </mat-option>
            </mat-select>
          </div>
          <div class="flex-div" style="display: flex;flex-direction: column;">
            <label style="color: #4272BF;">Local Purchase
            <input style="transform: scale(1.5);margin-left: 20px;
            margin-top: 30px;" type="checkbox"  name="local_purchase_checkbox" (change)="handleLocalPurchaseChange()">
          </label>
          </div>
          <div style="display: flex;flex-direction: column;">
            <label style="color: #4272BF; font-size: 14px;">Purchase request no </label>
            <input
              class = "reqNO"
              placeholder="Select Site Name First"
              formControlName="purchase_request_number"
              readonly
              [value]="requestNo"
              style="width:200px;padding:10px;border-radius: 6px;border:1px solid #9F9F9F;cursor: pointer;margin-top: 10px;font-family: 'Poppins';"
            >
          </div>
          <div class="flex-div" style="display: flex; flex-direction: column;" *ngIf="purchaseRequestForm.get('local_purchase')?.value === 'yes'">
            <label style="color: #4272BF; font-size: 14px;">Vendor<span class="star">*</span></label>
          
            <mat-select id="site" placeholder="Select Vendor" formControlName="vendor"
                        style="padding: 10px; width: 75%; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; font-family: 'Poppins';"
                        (selectionChange)="onVendorSelection($event)">
              <mat-option [value]="item._id" *ngFor="let item of vendorList">
                {{ item.vendor_name }}
              </mat-option>
            </mat-select>
          </div>
        </div>
      </mat-card>

      <ng-container *ngIf="purchaseRequestForm.get('local_purchase')?.value === 'yes',else noLocalPurchase">
        <div class="scroll-bar1">
          <table class="items-table" style="direction: ltr !important;border-left: 2px solid #000 !important;">
            <tr>
              <th>S&nbsp;No</th>
              <th>Item*</th>
              <th>Category</th>
              <th>Sub&nbsp;category</th>
              <th>Uom*</th>
              <th>Quantity*</th>
              <th>Brand Name</th>
              <!-- <th>Brand Name</th> -->
              <th>Rate</th>
              <!-- <th>Gst</th> -->
              <!-- <th>Freight</th> -->
              <th>Remarks</th>
              <th>Action</th>
            </tr>
  
  
  
            <tbody>
              <tr style="background-color: #F4F4F5;" formArrayName="items"
                *ngFor="let item of purchaseRequestForm.get('items')['controls']; let i = index;">
                <td style="text-align: center;">
                  {{i+1}}
                </td>
                <ng-container [formGroupName]="i">
                  <td>
                    <mat-form-field class="example-full-width">
                      <input
                        type="text"
                        placeholder="Select Item"
                        aria-label="Item"
                        matInput
                        [matAutocomplete]="auto"
                        formControlName="item_id"
                        (input)="searchItem($event)"
                      />
                      <mat-autocomplete #auto="matAutocomplete" [panelWidth]="'auto'" (optionSelected)="selectedItem($event, i)" [displayWith]="displayItemFn">
                        <mat-option *ngFor="let item of filteredItemList" [value]="item">
                          {{ item.item_name }}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </td>
                  <td style="color: #000;">
                    {{item.get('category')?.value}}
                  </td>
                  <td style="color: #000;">
                    {{item.get('subCategory')?.value}}
                  </td>
                  <td>
                    {{item.get('uom')?.value}}
                  </td>
                  <td>
                    <input type="text" placeholder="Enter" digitOnly formControlName="qty" class="pr-form-field">
                  </td>
                  <td>
                    <mat-form-field class="example-full-width">
                      <input
                        type="text"
                        placeholder="Select Brand"
                        aria-label="Brand"
                        matInput
                        [matAutocomplete]="fill"
                        formControlName="brandName"
                        (input)="searchBrand($event)"
                      />
                      <mat-autocomplete #fill="matAutocomplete" [displayWith]="displayBrandFn" [panelWidth]="'auto'">
                        <mat-option *ngFor="let brand of filteredBrandList" [value]="brand">
                          {{brand.brand_name}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </td>
                  <td>
                    <input type="text" placeholder="Enter" digitOnly formControlName="rate" class="pr-form-field">
                  </td>
                  <!-- <td>
                    <input type="text" placeholder="Enter"  formControlName="gst" class="pr-form-field">
                    {{ item.gstDetail.gst_percentage }}{{ item.gstDetail.gst_name }}
                    {{ item?.get('gstDetail')?.get('gst_percentage')?.value }}

                  </td> -->
                  <!-- <td>
                    <input placeholder="Enter" formControlName="freight" class="pr-form-field">
                  </td> -->
                  <td>
                    <input placeholder="Enter" formControlName="remark" class="pr-form-field">
                  </td>
                  <td>
                    <div class="action-btn-wrapper">
                      <a class="action-btn" (click)="delete(i)" *ngIf="i>0" title="Delete"><i class="fa fa-trash"></i></a>
                    </div>
                  </td>
                </ng-container>
              </tr>
            </tbody>
          </table>
        </div>
  
        <div
          style="display: flex;flex-direction: row;gap: 40px;margin-left:38px;margin-bottom:100px;margin-top:100px;top: -50px;position: relative;">
          <div>
            <button
              style="padding: 8px ;width: 120px;background-color: #fff;cursor: pointer;border: 0.5px solid #94A3B8;border-radius: 5px;font-size: 14px;font-family: 'Poppins';"
              (click)="addItem()">
              Add Item +
            </button>
          </div>
        </div>
        <div style="
        display: flex;
        justify-content: center;
        margin-top: -126px;
        margin-bottom: 20px;
      ">
        <!-- Show the button if addPermission is true -->
        <button *ngIf="addPermission"
          style="
            padding: 8px;
            width: 120px;
            background-color: #233A61;
            color: #fff;
            border-radius: 5px;
            border-color: lightgrey;
            font-size: 14px;
            font-family: 'Poppins';
          "
        >
          Submit
        </button>

        <!-- Show the message if addPermission is false -->
        <h2 *ngIf="!addPermission" style="color: red;">
          You don't have permission to add
        </h2>
      </div>
      
      </ng-container>
      <ng-template #noLocalPurchase>
        <div class="scroll-bar1">
          <table class="items-table" style="direction: ltr !important;border-left: 2px solid #000 !important;">
            <tr>
              <th>S&nbsp;No</th>
              <th>Item*</th>
              <th>Category</th>
              <th>Sub&nbsp;category</th>
              <th>Uom*</th>
              <th>Quantity*</th>
              <th>Brand Name</th>
              <th>Remarks</th>
              <th>Action</th>
            </tr>
  
  
  
            <tbody>
              <tr style="background-color: #F4F4F5;" formArrayName="items"
                *ngFor="let item of purchaseRequestForm.get('items')['controls']; let i = index;">
                <td style="text-align: center;">
                  {{i+1}}
                </td>
                <ng-container [formGroupName]="i">

    

                  <td>
                    <mat-form-field class="example-full-width" >
                      <input
                        type="text"
                        placeholder="Select Item"
                        aria-label="Item"
                        matInput
                        [matAutocomplete]="auto"
                        formControlName="item_id"
                        (input)="searchItem($event)"
                      />
                      <mat-autocomplete #auto="matAutocomplete" [panelWidth]="'auto'"(optionSelected)="selectedItem($event, i)" [displayWith]="displayItemFn">
                        <mat-option *ngFor="let item of filteredItemList" [value]="item">
                          {{ item.item_name }}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </td>
                  

                  <td style="color: #000;">
                    {{item.get('category')?.value}}
                  </td>
                  <td style="color: #000;">
                    {{item.get('subCategory')?.value}}
                  </td>
                  <td>
                    {{item.get('uom')?.value}}
                    <!-- <mat-select id="itemName" placeholder="Select UOM" formControlName="uom" class="select-form-field">
                      <mat-option [value]="item._id" *ngFor="let item of uomList">
                        {{item.unit}}
                      </mat-option>
  
                    </mat-select> -->
                  </td>
                  <td>
                    <input type="text" placeholder="Enter" digitOnly formControlName="qty" class="pr-form-field">
                  </td>
                  <td>
                    <mat-form-field class="example-full-width">
                      <input
                        type="text"
                        placeholder="Select Brand"
                        aria-label="Brand"
                        matInput
                        [matAutocomplete]="fill"
                        formControlName="brandName"
                        (input)="searchBrand($event)"
                      />
                      <mat-autocomplete #fill="matAutocomplete" [displayWith]="displayBrandFn" [panelWidth]="'auto'">
                        <mat-option *ngFor="let brand of filteredBrandList" [value]="brand">
                          {{brand.brand_name}}
                        </mat-option>
                      </mat-autocomplete>
                    </mat-form-field>
                  </td>
                  


       
                
                  <td>
                    <input placeholder="Enter" formControlName="remark" class="pr-form-field">
                  </td>
                  <td>
                    <div class="action-btn-wrapper">
                      <a class="action-btn" (click)="delete(i)" *ngIf="i>0" title="Delete"><i class="fa fa-trash"></i></a>
                    </div>
                  </td>
                </ng-container>
              </tr>
            </tbody>
          </table>
        </div>
  
        <div
          style="display: flex;flex-direction: row;gap: 40px;margin-left:38px;margin-bottom:100px;margin-top:100px;top: -50px;position: relative;">
          <div>
            <button
              style="padding: 8px ;width: 120px;background-color: #fff;cursor: pointer;border: 0.5px solid #94A3B8;border-radius: 5px;font-size: 14px;font-family: 'Poppins';"
              (click)="addItem()">
              Add Item +
            </button>
          </div>
        </div>
        <div style="
          display: flex;
          justify-content: center;
          margin-top: -126px;
          margin-bottom: 20px;
        ">
          <!-- Show the button if addPermission is true -->
          <button *ngIf="addPermission"
            style="
              padding: 8px;
              width: 120px;
              background-color: #233A61;
              color: #fff;
              border-radius: 5px;
              border-color: lightgrey;
              font-size: 14px;
              font-family: 'Poppins';
            "
          >
            Submit
          </button>

          <!-- Show the message if addPermission is false -->
          <h2 *ngIf="!addPermission" style="color: red;">
            You don't have permission to add
          </h2>
        </div>

      </ng-template>
      


    </form>
  </ng-container>

  <ng-container *ngIf="option==2">

    <div style="display: flex;flex-direction: row;gap:10px;    margin: 0 27px;">
      <div>
        <div style="margin-top: 15px;color: #94A3B8;"> <span>Filter by title </span></div>
        <mat-form-field appearance="outline" class="searchbar">
          <mat-icon matSuffix>search</mat-icon>
          <input matInput type="search" placeholder="search title" class="search-input"
            (input)="search($event,'title')">

        </mat-form-field>
      </div>

      <div>
        <div style="margin-top: 15px;color: #94A3B8;"> <span>Filter by date</span></div>
        <div> <mat-form-field appearance="outline" class="datebar">
            <input matInput [matDatepicker]="startPicker" placeholder="Date" (dateChange)="dateFilter( $event)"
              (click)="startPicker.open()" />
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field></div>
      </div>

      <div>

        <div style="margin-top: 15px;color: #94A3B8;"> <span>Filter by site</span></div>
        <div> <mat-form-field appearance="outline" class="datebar">
            <input matInput placeholder="Site" (input)="search($event,'site')" />
          </mat-form-field></div>
      </div>


      <div class="custom-form-group">

        <div style="margin-top: 15px;color: #94A3B8;"> <span>Filter by Status</span></div>
        <div class="custom-form-control" style="position: relative;">

          <mat-form-field appearance="outline">
            <mat-select [formControl]="statusOption" (selectionChange)="onStatusChange($event)">
              <mat-option [value]="item.value" *ngFor="let item of statusList">{{item.label}}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

    </div>


    <div class="scroll-bar1" style="width: 93%;">
      <table style="direction: ltr !important;margin-top: -20px;" class="r-list">



        <tbody>
          <tr *ngFor="let obj of purchaseList">
            <td style="color: #4272BF;width:300px;text-align: left;padding: 18px;">Request&nbsp;no:
              {{obj.purchase_request_number}}</td>

            <td style="color: #4272BF;width:200px;">Title: {{obj.title}}</td>

            <td style="color: #4272BF;width:800px;text-align: left;padding: 18px;">Site: {{obj.siteData.site_name}}
            </td>
            <td *ngIf="obj.status=='pending'" style="width: 20%;
            text-align: right;">
              <a class="viewdetail-btn" [routerLink]="['/procurement/details',obj._id]">
                View&nbsp;details
              </a>
            </td>
            <td *ngIf="obj.status=='approved'" style="width: 20%;
            text-align: right;">

              <a class="viewdetail-btn" [routerLink]="['/procurement/details',obj._id]"
                style="background-color: #54AA52;color:#fff;">
                Approved ticket
              </a>
            </td>
            <td *ngIf="obj.status=='rejected'" style="width: 20%;
            text-align: right;">
              <a class="viewdetail-btn" [routerLink]="['/procurement/details',obj._id]"
                style="background-color: #C7323B;color:#fff;">
                Rejected
              </a>
            </td>
            <td *ngIf="obj.status=='revise'" style="width: 20%;
            text-align: right;">
              <a *ngIf="editPermission; else disabledState"
              class="viewdetail-btn" [routerLink]="['/procurement/revise',obj._id]"
                style="background-color: #ECD172;color:#fff;">
                Revise
              </a>
           
           <ng-template #disabledState>
              <span class="viewdetail-btn" style="background-color: #ECD172;color:#fff;">
                 No permission to revise
              </span>
           </ng-template>
            </td>
            <td style="width: 100px;"><mat-icon>
                arrow_forward_ios
              </mat-icon></td>
          </tr>
        </tbody>
      </table>
      <div class="no-record-found" *ngIf="!(purchaseList && purchaseList.length>0)">
        <img src="./assets/images/inbox_empty.png" alt="">
        <span> No record found</span>
      </div>
    </div>
  </ng-container>
</ng-container>
<ng-template #noView>
  <h3 style="    display: flex;
  justify-content: center;
  margin-top: 2%;
  font-size: 160%;
  font-weight: bolder;
  color: grey;">You don't have permissions to view.</h3>
</ng-template>
 

</div>
